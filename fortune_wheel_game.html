<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CyberSpinWin</title>
  <style>
    :root {
      --color-primary: #0ff;
      --color-secondary: #f0f;
      --color-bg: #111;
    }
    
    body {
      font-family: 'Arial', sans-serif;
      background: var(--color-bg);
      color: white;
      text-align: center;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    
    .wheel-container {
      position: relative;
      width: 300px;
      height: 300px;
      margin: 40px auto;
    }
    
    .wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 8px solid var(--color-primary);
      position: relative;
      overflow: hidden;
      transition: transform 4s cubic-bezier(0.17, 0.67, 0.21, 0.99);
      transform: rotate(0deg);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      background: conic-gradient(
          #0ff 0% 16.6%,
          #f0f 16.6% 33.3%,
          #ff0 33.3% 50%,
          #0f0 50% 66.6%,
          #f00 66.6% 83.3%,
          #00f 83.3% 100%
      );
    }
    
    .pointer {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-bottom: 30px solid white;
      z-index: 10;
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7));
    }
    
    .spin-btn {
      background: linear-gradient(45deg, var(--color-primary), var(--color-secondary));
      color: black;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      margin: 20px 0;
      transition: all 0.3s;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
    }
    
    .spin-btn:disabled {
      background: #555;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .result {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 10px;
      margin: 20px auto;
      max-width: 80%;
      min-height: 50px;
    }
  </style>
</head>
<body>
  <h1>CyberSpinWin</h1>
  
  <div class="wheel-container">
    <div class="pointer"></div>
    <div class="wheel" id="wheel"></div>
  </div>
  
  <button class="spin-btn" id="spinBtn">SPIN WHEEL</button>
  <div class="result" id="result"></div>

  <script>
    // –£–∫–∞–∂–∏—Ç–µ URL –≤–∞—à–µ–≥–æ API (—Ç–æ—Ç –∂–µ, —á—Ç–æ –∏ —É –≤–∞—à–µ–≥–æ HTTP-—Å–µ—Ä–≤–µ—Ä–∞)
    const API_URL = "https://tricky-chicken-80.telebit.io";
    
    // –°–ø–∏—Å–æ–∫ –ø—Ä–∏–∑–æ–≤ –∏ —É–≥–ª—ã –¥–ª—è —Å–µ–∫—Ç–æ—Ä–æ–≤
    const prizes = ["100‚ÇΩ", "Stickers", "Bonus", "Try Again", "Discount", "Mystery Prize"];
    const sectorAngles = [30, 90, 150, 210, 270, 330];
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const wheel = document.getElementById('wheel');
    const spinBtn = document.getElementById('spinBtn');
    const resultDiv = document.getElementById('result');
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    let code = urlParams.get('code');
    if(!code){
      resultDiv.textContent = "‚ö†Ô∏è –ö–æ–¥ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ URL";
      spinBtn.disabled = true;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∞ –Ω–∞ —Å–ø–∏–Ω –ø–æ –∫–æ–¥—É
    async function checkSpinEligibility() {
      try {
        const response = await fetch(`${API_URL}/api/can_spin`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({code: code})
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        if (data.error) {
          resultDiv.textContent = `‚ö†Ô∏è Error: ${data.error}`;
          spinBtn.disabled = true;
          return false;
        }
        if (!data.can_spin) {
          resultDiv.textContent = "‚õî –≠—Ç–æ—Ç –∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!";
          spinBtn.disabled = true;
          return false;
        }
        return true;
      } catch (error) {
        console.error("API error:", error);
        resultDiv.textContent = "‚ö†Ô∏è Connection error";
        spinBtn.disabled = true;
        return false;
      }
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–ø–∏–Ω–∞ –∏ –ø–æ–º–µ—Ç–∫–∞ –∫–æ–¥–∞ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–≥–æ
    async function saveSpinResult(prize) {
      try {
        const response = await fetch(`${API_URL}/api/save_spin`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            code: code,
            prize: prize,
            user_id: 0 // –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π user_id, –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        if (data.error) {
          console.error("Failed to save result:", data.error);
        }
      } catch (error) {
        console.error("Failed to save result:", error);
      }
    }
    
    // –°–ø–∏–Ω –∫–æ–ª–µ—Å–∞
    spinBtn.addEventListener('click', async function() {
      if (this.disabled) return;
      
      const eligible = await checkSpinEligibility();
      if(!eligible) return;
      
      this.disabled = true;
      resultDiv.textContent = "üåÄ Spinning...";
      
      const prizeIndex = Math.floor(Math.random() * prizes.length);
      const spinDegrees = 360 * 5 + sectorAngles[prizeIndex];
      
      wheel.style.transform = `rotate(-${spinDegrees}deg)`;
      
      setTimeout(async () => {
        const prize = prizes[prizeIndex];
        resultDiv.textContent = `üéâ You won: ${prize}!`;
        await saveSpinResult(prize);
      }, 4000);
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    (async function() {
      await checkSpinEligibility();
    })();
  </script>
</body>
</html>
