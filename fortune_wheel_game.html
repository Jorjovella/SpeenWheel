<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Cyber Neon Wheel</title>
  <style>
    body {
      background: radial-gradient(ellipse at center, #0f0c29, #302b63, #24243e);
      color: #0ff;
      font-family: 'Arial', sans-serif;
      text-align: center;
      padding: 40px;
    }
    canvas {
      background: transparent;
      display: block;
      margin: 0 auto;
    }
    #spin {
      margin-top: 30px;
      padding: 10px 25px;
      font-size: 20px;
      background: #00ffff33;
      border: 2px solid #0ff;
      color: #0ff;
      cursor: pointer;
      border-radius: 10px;
      transition: 0.3s;
    }
    #spin:hover {
      background: #0ff;
      color: #000;
    }
    #history {
      margin-top: 40px;
      font-size: 16px;
      color: #0ff;
    }
  </style>
</head>
<body>

  <h1>üéØ –ö–∏–±–µ—Ä-–ù–µ–æ–Ω–æ–≤–æ–µ –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</h1>
  <canvas id="wheel" width="500" height="500"></canvas>
  <button id="spin">–ö—Ä—É—Ç–∏—Ç—å</button>

  <div id="history"></div>

  <!-- ‚úÖ Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand(); // –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    const user_id = tg?.initDataUnsafe?.user?.id;

    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    const spinButton = document.getElementById("spin");

    const API_URL = "https://yourdomain.com/api/save_win"; // üîÅ –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä

    const prizes = [
      { label: "üîÆ 100 –±–∞–ª–ª–æ–≤", color: "#0ff", chance: 20 },
      { label: "üíé 200 –±–∞–ª–ª–æ–≤", color: "#0f0", chance: 15 },
      { label: "üéÅ 300 –±–∞–ª–ª–æ–≤", color: "#f0f", chance: 10 },
      { label: "üçÄ –£–¥–∞—á–∞!", color: "#ff0", chance: 5 },
      { label: "‚ùå –ü—É—Å—Ç–æ", color: "#f00", chance: 50 }
    ];

    const totalChance = prizes.reduce((sum, p) => sum + p.chance, 0);
    const numSectors = prizes.length;
    const arc = 2 * Math.PI / numSectors;
    let angle = 0;
    let isSpinning = false;

    function drawWheel() {
      for (let i = 0; i < numSectors; i++) {
        const start = angle + i * arc;
        const end = start + arc;
        ctx.beginPath();
        ctx.fillStyle = prizes[i].color;
        ctx.arc(250, 250, 240, start, end);
        ctx.lineTo(250, 250);
        ctx.fill();
        ctx.save();
        ctx.translate(250, 250);
        ctx.rotate(start + arc / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#000";
        ctx.font = "bold 16px Arial";
        ctx.fillText(prizes[i].label, 230, 10);
        ctx.restore();
      }
    }

    function pickPrize() {
      const rand = Math.random() * totalChance;
      let sum = 0;
      for (let i = 0; i < prizes.length; i++) {
        sum += prizes[i].chance;
        if (rand <= sum) return i;
      }
      return prizes.length - 1;
    }

    function spinWheel() {
      if (isSpinning) return;
      isSpinning = true;

      const resultIndex = pickPrize();
      const fullTurns = 5;
      const finalAngle = (numSectors - resultIndex) * arc - arc / 2;
      const targetAngle = fullTurns * 2 * Math.PI + finalAngle;
      let start = performance.now();

      function animate(time) {
        const duration = 4000;
        const progress = Math.min((time - start) / duration, 1);
        angle = easeOutCubic(progress) * targetAngle;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawWheel();
        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          const result = prizes[resultIndex];
          alert(`üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: ${result.label}`);
          saveHistory(result.label);
          sendResultToServer(result.label);
          isSpinning = false;
        }
      }

      requestAnimationFrame(animate);
    }

    function easeOutCubic(x) {
      return 1 - Math.pow(1 - x, 3);
    }

    function saveHistory(prize) {
      const history = JSON.parse(localStorage.getItem("wheelHistory") || "[]");
      history.unshift({ prize: prize, time: new Date().toLocaleString() });
      localStorage.setItem("wheelHistory", JSON.stringify(history));
      updateHistory();
    }

    function updateHistory() {
      const container = document.getElementById("history");
      const history = JSON.parse(localStorage.getItem("wheelHistory") || "[]");
      container.innerHTML = "<h3>üìú –ò—Å—Ç–æ—Ä–∏—è –≤—ã–∏–≥—Ä—ã—à–µ–π:</h3>" +
        history.slice(0, 10).map(h =>
          `<div>üéØ <b>${h.prize}</b> ‚Äî <small>${h.time}</small></div>`).join("");
    }

    async function sendResultToServer(prize) {
      if (!user_id) {
        console.error("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Telegram user_id");
        return;
      }
      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: user_id, prize: prize })
        });
        const data = await response.json();
        console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", e);
      }
    }

    spinButton.addEventListener("click", spinWheel);
    drawWheel();
    updateHistory();
  </script>

</body>
</html>
